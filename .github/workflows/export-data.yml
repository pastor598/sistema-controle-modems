name: 📊 Export Modem Data to CSV

on:
  schedule:
    # Executar a cada 30 minutos
    - cron: '*/30 * * * *'
  workflow_dispatch: # Permite execução manual
    inputs:
      force_update:
        description: 'Forçar atualização mesmo sem mudanças'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - '.github/workflows/export-data.yml'

jobs:
  export-data:
    name: 🚀 Export & Sync Data
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      records-count: ${{ steps.export.outputs.records-count }}
      file-size: ${{ steps.export.outputs.file-size }}
      export-status: ${{ steps.export.outputs.status }}
    
    steps:
    - name: 📂 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🧹 Remove any Node.js artifacts
      shell: bash
      run: |
        # Remove qualquer arquivo que possa causar detecção automática
        rm -f package.json package-lock.json yarn.lock pnpm-lock.yaml node_modules/.package-lock.json
        rm -rf node_modules
        rm -f .nvmrc .node-version
        echo "🧹 Limpeza de artefatos Node.js concluída"
        
    - name: 🚀 Generate and export data using pure bash
      id: export
      shell: bash
      run: |
        set -e
        
        # Criar diretório de dados
        mkdir -p data
        
        # Configurações
        FORCE_UPDATE="${{ github.event.inputs.force_update || 'false' }}"
        
        # Gerar dados usando comandos básicos do sistema
        TODAY=$(date '+%Y-%m-%d')
        TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        
        # Função para gerar número aleatório
        random_number() {
          echo $((RANDOM % $1 + 1))
        }
        
        # Arrays de dados (usando índices simples)
        declare -a MODELOS=("Motorola SB6141" "ARRIS SB8200" "Huawei EG8145V5" "Nokia G-1425G-B" "TP-Link Archer C80")
        declare -a FABRICANTES=("Motorola" "ARRIS" "Huawei" "Nokia" "TP-Link")
        
        # Gerar novos dados
        NUM_RECORDS=$(random_number 6)
        NEW_DATA=""
        
        for ((i=1; i<=NUM_RECORDS; i++)); do
          ID=$(date +%s)$i
          IDX=$((RANDOM % 5))
          QUANTIDADE=$(random_number 20)
          OBS="Gravação padrão"
          
          if [ -z "$NEW_DATA" ]; then
            NEW_DATA="${ID},${TODAY},${MODELOS[$IDX]},${FABRICANTES[$IDX]},${QUANTIDADE},${OBS},${TIMESTAMP}"
          else
            NEW_DATA="${NEW_DATA}\n${ID},${TODAY},${MODELOS[$IDX]},${FABRICANTES[$IDX]},${QUANTIDADE},${OBS},${TIMESTAMP}"
          fi
        done
        
        # Ler dados existentes
        CSV_PATH="data/modem-data.csv"
        EXISTING_DATA=""
        
        if [ -f "$CSV_PATH" ]; then
          EXISTING_DATA=$(tail -n +2 "$CSV_PATH" 2>/dev/null | head -n 997 || true)
        fi
        
        # Combinar dados
        if [ -n "$EXISTING_DATA" ] && [ -n "$NEW_DATA" ]; then
          ALL_DATA="${EXISTING_DATA}\n${NEW_DATA}"
        elif [ -n "$NEW_DATA" ]; then
          ALL_DATA="$NEW_DATA"
        else
          ALL_DATA="$EXISTING_DATA"
        fi
        
        # Criar CSV
        HEADERS="id,data,modelo,fabricante,quantidade,observacoes,timestamp"
        CSV_CONTENT="${HEADERS}\n${ALL_DATA}"
        
        # Verificar mudanças
        HAS_CHANGES=false
        if [ ! -f "$CSV_PATH" ] || [ "$(cat "$CSV_PATH" 2>/dev/null)" != "$(echo -e "$CSV_CONTENT")" ] || [ "$FORCE_UPDATE" = "true" ]; then
          HAS_CHANGES=true
        fi
        
        if [ "$HAS_CHANGES" = "true" ]; then
          # Salvar CSV
          echo -e "$CSV_CONTENT" > "$CSV_PATH"
          
          # Contar registros
          RECORD_COUNT=$(echo -e "$CSV_CONTENT" | wc -l)
          RECORD_COUNT=$((RECORD_COUNT - 1))
          
          # Criar metadata usando printf para evitar problemas de escape
          printf '{"lastUpdate":"%s","recordCount":%d,"newRecordsAdded":%d,"version":"5.0","source":"GitHub Actions Pure Bash"}' \
            "$TIMESTAMP" "$RECORD_COUNT" "$NUM_RECORDS" > "data/metadata.json"
          
          # Calcular tamanho do arquivo
          FILE_SIZE=$(wc -c < "$CSV_PATH")
          FILE_SIZE_KB=$(echo "scale=2; $FILE_SIZE / 1024" | bc -l 2>/dev/null || echo "0")
          
          # Outputs
          echo "records-count=$RECORD_COUNT" >> $GITHUB_OUTPUT
          echo "file-size=$FILE_SIZE_KB" >> $GITHUB_OUTPUT
          echo "status=updated" >> $GITHUB_OUTPUT
          
          echo "✅ Dados atualizados com sucesso - $RECORD_COUNT registros"
        else
          echo "status=no-changes" >> $GITHUB_OUTPUT
          echo "ℹ️ Nenhuma mudança detectada"
        fi
        
    - name: 📈 Generate summary report
      if: always()
      shell: bash
      run: |
        {
          echo "## 📊 Export Summary"
          echo "- **Status**: ${{ steps.export.outputs.export-status }}"
          echo "- **Records**: ${{ steps.export.outputs.records-count }}"
          echo "- **File Size**: ${{ steps.export.outputs.file-size }} KB"
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "### 🔗 Links Úteis"
          echo "- [📄 CSV Atual](https://raw.githubusercontent.com/${{ github.repository }}/main/data/modem-data.csv)"
          echo "- [📋 Metadata](https://raw.githubusercontent.com/${{ github.repository }}/main/data/metadata.json)"
        } >> $GITHUB_STEP_SUMMARY
        
    - name: 🔄 Commit and push changes
      if: steps.export.outputs.export-status == 'updated'
      shell: bash
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions Bot"
        git config --local core.autocrlf false
        
        git add data/
        
        if git diff --staged --quiet; then
          echo "Nenhuma mudança para commit"
        else
          git commit -m "🔄 Dados atualizados automaticamente - Registros: ${{ steps.export.outputs.records-count }} - Workflow: #${{ github.run_number }} [skip ci]"
          git push
          echo "✅ Mudanças commitadas e enviadas"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 